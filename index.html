<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asistencia Escolar | Profe JB</title>
  <!-- TailwindCSS CDN (para estilos rápidos) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM + Babel (para escribir JSX en un solo archivo) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✅</text></svg>">
  <style>
    /* Evita el parpadeo en dark mode del CDN */
    html { color-scheme: light; }
    /* Scroll bonito para tablas largas */
    .scroll-thin { scrollbar-width: thin; }
  </style>
  <!-- PWA meta y manifest -->
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    // ===================== CONFIGURACIÓN BÁSICA =====================
    // === Autenticación simple (local, sin servidor) ===
    // Cambia estos usuarios y contraseñas a tu gusto.
    const AUTH_USERS = [
      { user: 'profe', pass: 'jb2025', role: 'admin', nombre: 'Profe JB' },
      { user: 'ayudante', pass: '1234', role: 'invitado', nombre: 'Auxiliar' },
    ];
    const AUTH_STORAGE_KEY = 'asistenciaAuthV1';
    const MATERIAS = [
      { id: 'PMI', nombre: 'Pensamiento Matemático I' },
      { id: 'PMIII', nombre: 'Pensamiento Matemático III' },
      { id: 'PVI', nombre: 'Pensamiento Variacional I' },
      { id: 'LEN', nombre: 'La energía' },
    ];

    const ESTADOS = [
      { id: 'A', label: 'Asistencia' },
      { id: 'F', label: 'Falta' },
      { id: 'R', label: 'Retardo' },
      { id: 'J', label: 'Justificada' },
    ];

    const STORAGE_KEY = 'asistenciaAppV1';

    // ===================== UTILIDADES =====================
    const hoyISO = () => new Date().toISOString().slice(0,10);

    const uid = () => Math.random().toString(36).slice(2,9);

    const toCSV = (rows) => {
      if (!rows || rows.length === 0) return '';
      const cols = Object.keys(rows[0]);
      const header = cols.join(',');
      const body = rows.map(r => cols.map(c => {
        const v = (r[c] ?? '').toString().replaceAll('"', '""');
        const needsQuotes = /[",\n]/.test(v);
        return needsQuotes ? `"${v}"` : v;
      }).join(',')).join('\n');
      return header + '\n' + body;
    }

    const download = (filename, content, mime='text/plain') => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([content], {type: mime}));
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ===================== PERSISTENCIA =====================
    const defaultData = () => ({
      materias: Object.fromEntries(MATERIAS.map(m => [m.id, { alumnos: [], asistencias: {} }]))
    });

    const loadData = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : defaultData();
      } catch (e) {
        console.error('Error cargando datos', e);
        return defaultData();
      }
    };

    const saveData = (data) => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    };

    // ===================== COMPONENTES =====================
    function Badge({children}) {
      return <span className="px-2 py-0.5 rounded-full text-xs bg-slate-200">{children}</span>;
    }

    function Pill({active, onClick, children}) {
      return (
        <button onClick={onClick}
          className={`px-3 py-1 rounded-full text-sm border ${active ? 'bg-slate-900 text-white border-slate-900' : 'bg-white hover:bg-slate-100 border-slate-300'}`}>
          {children}
        </button>
      )
    }

    function Select({value, onChange, options}) {
      return (
        <select value={value} onChange={e => onChange(e.target.value)}
          className="border rounded-lg px-3 py-2 bg-white w-full">
          {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
        </select>
      );
    }

    function Tabs({tabs, current, setCurrent}) {
      return (
        <div className="flex flex-wrap gap-2">
          {tabs.map(t => (
            <Pill key={t.id} active={current === t.id} onClick={() => setCurrent(t.id)}>
              {t.label}
            </Pill>
          ))}
        </div>
      )
    }

    // ------ Gestión de Alumnos ------
    function Alumnos({materiaId, data, setData}) {
      const [nombre, setNombre] = React.useState('');

      const alumnos = data.materias[materiaId].alumnos;

      const addAlumno = () => {
        const n = nombre.trim();
        if (!n) return;
        const nuevo = { id: uid(), nombre: n };
        const next = {...data};
        next.materias[materiaId].alumnos = [...alumnos, nuevo];
        setData(next);
        saveData(next);
        setNombre('');
      };

      const removeAlumno = (id) => {
        if (!confirm('¿Eliminar alumno? Se conservará su historial, pero ya no aparecerá en pases nuevos.')) return;
        const next = {...data};
        next.materias[materiaId].alumnos = alumnos.filter(a => a.id !== id);
        setData(next);
        saveData(next);
      };

      const ordenar = () => {
        const next = {...data};
        next.materias[materiaId].alumnos = [...alumnos].sort((a,b)=> a.nombre.localeCompare(b.nombre, 'es'));
        setData(next);
        saveData(next);
      };

      return (
        <div className="space-y-4">
          <div className="grid md:grid-cols-3 gap-2">
            <div className="md:col-span-2">
              <label className="text-sm font-medium">Nombre del alumno</label>
              <input value={nombre} onChange={e=>setNombre(e.target.value)} placeholder="Ej. Ana Paola Torres"
                     className="mt-1 w-full border rounded-lg px-3 py-2" />
            </div>
            <div className="flex items-end gap-2">
              <button onClick={addAlumno} className="w-full px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Agregar</button>
              <button onClick={ordenar} className="px-3 py-2 rounded-lg bg-slate-200 hover:bg-slate-300">Ordenar A→Z</button>
            </div>
          </div>

          <div className="bg-white rounded-xl shadow p-4">
            <div className="flex items-center justify-between mb-2">
              <h3 className="font-semibold">Lista de alumnos <Badge>{alumnos.length}</Badge></h3>
            </div>
            <div className="max-h-80 overflow-auto scroll-thin">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left border-b">
                    <th className="py-2 pr-2">Nombre</th>
                    <th className="py-2">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {alumnos.map(a => (
                    <tr key={a.id} className="border-b last:border-0">
                      <td className="py-2 pr-2">{a.nombre}</td>
                      <td className="py-2">
                        <button onClick={()=>removeAlumno(a.id)} className="text-red-600 hover:underline">Eliminar</button>
                      </td>
                    </tr>
                  ))}
                  {alumnos.length===0 && (
                    <tr><td colSpan="2" className="py-6 text-center text-slate-500">Sin alumnos. Agrega arriba ⤴️</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

    // ------ Pase de Lista ------
    function PaseLista({materiaId, data, setData}) {
      const alumnos = data.materias[materiaId].alumnos;
      const [fecha, setFecha] = React.useState(hoyISO());

      const registro = data.materias[materiaId].asistencias[fecha] || {};

      const setEstado = (alumnoId, estado) => {
        const next = {...data};
        if (!next.materias[materiaId].asistencias[fecha]) next.materias[materiaId].asistencias[fecha] = {};
        next.materias[materiaId].asistencias[fecha][alumnoId] = estado;
        setData(next);
        saveData(next);
      };

      const setTodos = (estado) => {
        const next = {...data};
        if (!next.materias[materiaId].asistencias[fecha]) next.materias[materiaId].asistencias[fecha] = {};
        alumnos.forEach(a => { next.materias[materiaId].asistencias[fecha][a.id] = estado; });
        setData(next);
        saveData(next);
      };

      return (
        <div className="space-y-4">
          <div className="flex flex-wrap items-end gap-2">
            <div>
              <label className="text-sm font-medium">Fecha</label>
              <input type="date" value={fecha} onChange={e=>setFecha(e.target.value)} className="mt-1 border rounded-lg px-3 py-2" />
            </div>
            <div className=\"flex gap-2\">
                <button id=\"btnInstall\" className=\"px-3 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700\">Instalar en este dispositivo</button>
                <div className=\"px-3 py-2 rounded-lg bg-slate-100 text-slate-700\">
                  <span class=\"font-semibold\">{session.nombre}</span> · <span className=\"uppercase text-xs\">{session.role}</span>
                </div>
                <button onClick={onLogout} className=\"px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700\">Salir</button>
              </div>
            </div>
          </header>

          <section className="mb-4 grid md:grid-cols-3 gap-3">
            <div className="md:col-span-2">
              <label className="text-sm font-medium">Materia</label>
              <Select value={materiaId} onChange={setMateriaId} options={materiaOptions} />
            </div>
            <div>
              <label className="text-sm font-medium">Secciones</label>
              <Tabs tabs={tabs} current={tab} setCurrent={setTab} />
            </div>
          </section>

          {tab === 'alumnos' && <Alumnos materiaId={materiaId} data={data} setData={setData} />}
          {tab === 'pase' && <PaseLista materiaId={materiaId} data={data} setData={setData} />}
          {tab === 'reportes' && <Reportes materiaId={materiaId} data={data} />}
          {tab === 'respaldos' && <Respaldos materiaId={materiaId} data={data} setData={setData} />}

          <footer className="mt-10 text-sm text-slate-500">
            <p>Hecho con ❤️ por el Profe — Datos guardados en <code>localStorage</code>. Exporta un respaldo si cambias de equipo.</p>
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    // ===== PWA: instalación y Service Worker =====
    // Captura del evento beforeinstallprompt para mostrar botón de instalación
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('btnInstall');
      if (btn) btn.style.display = 'inline-flex';
    });

    const btn = document.getElementById('btnInstall');
    if (btn) {
      btn.style.display = 'none'; // oculto por defecto hasta que sea instalable
      btn.addEventListener('click', async () => {
        if (!deferredPrompt) return alert('Si el botón no responde, abre desde HTTPS (GitHub Pages) y vuelve a intentar.');
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          console.log('PWA instalada');
        }
        deferredPrompt = null;
      });
    }

    // Registro del Service Worker (requerido para PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
